<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.23" /><meta name="theme" content="VuePress Theme Plume 1.0.0-rc.155" /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"TargetDiff","image":[""],"dateModified":"2025-05-23T11:04:23.000Z","author":[]}</script><meta property="og:url" content="https://velvet-notes.org/papers/%E5%88%86%E5%AD%90%E7%94%9F%E6%88%90/targetdiff"><meta property="og:site_name" content="Velvet-Notes"><meta property="og:title" content="TargetDiff"><meta property="og:description" content="TargetDiff 概述 TargetDiff 在干什么 TargetDiff是一种基于三维等变扩散模型的分子生成工具，专注于目标蛋白感知的分子设计和结合亲和力预测，旨在加速药物发现进程。其核心应用包括： 靶向分子生成：根据目标蛋白的三维结合口袋结构，生成与之空间匹配且具有高结合亲和力的候选分子（例如小分子配体） 结合亲和力预测：通过无监督特征提取，..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-05-23T11:04:23.000Z"><meta property="article:tag" content="扩散模型"><meta property="article:tag" content="配体生成"><meta property="article:modified_time" content="2025-05-23T11:04:23.000Z"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><title>TargetDiff | Velvet-Notes</title><meta name="description" content="TargetDiff 概述 TargetDiff 在干什么 TargetDiff是一种基于三维等变扩散模型的分子生成工具，专注于目标蛋白感知的分子设计和结合亲和力预测，旨在加速药物发现进程。其核心应用包括： 靶向分子生成：根据目标蛋白的三维结合口袋结构，生成与之空间匹配且具有高结合亲和力的候选分子（例如小分子配体） 结合亲和力预测：通过无监督特征提取，..."><link rel="preload" href="/assets/style-BGE8C2tN.css" as="style"><link rel="stylesheet" href="/assets/style-BGE8C2tN.css"><link rel="modulepreload" href="/assets/app-nJSYOaSR.js"><link rel="modulepreload" href="/assets/targetdiff.html-DJ4ChdEc.js"><link rel="prefetch" href="/assets/index.html-DpWD9FS0.js" as="script"><link rel="prefetch" href="/assets/index.html-XI02li_r.js" as="script"><link rel="prefetch" href="/assets/envtips.html-G0X9nd2r.js" as="script"><link rel="prefetch" href="/assets/index.html-2zqwryLw.js" as="script"><link rel="prefetch" href="/assets/index.html-ixjxCYiW.js" as="script"><link rel="prefetch" href="/assets/index.html-Bl9idUjm.js" as="script"><link rel="prefetch" href="/assets/index.html-CABPt5Pp.js" as="script"><link rel="prefetch" href="/assets/index.html-uJRHY0H6.js" as="script"><link rel="prefetch" href="/assets/index.html-B6mq4iEn.js" as="script"><link rel="prefetch" href="/assets/index.html-DXZVIx1b.js" as="script"><link rel="prefetch" href="/assets/index.html-1xKjEa72.js" as="script"><link rel="prefetch" href="/assets/frag2seq.html-BNlp20Lo.js" as="script"><link rel="prefetch" href="/assets/ipdiff.html-CnGOPjd8.js" as="script"><link rel="prefetch" href="/assets/pocketgen.html-CgZjAkqj.js" as="script"><link rel="prefetch" href="/assets/ddpm.html-BV2yRF5A.js" as="script"><link rel="prefetch" href="/assets/resnet.html-BEZsIIkT.js" as="script"><link rel="prefetch" href="/assets/transformer.html-D6Vor5lw.js" as="script"><link rel="prefetch" href="/assets/404.html-CKywGOP_.js" as="script"><link rel="prefetch" href="/assets/index.html-B1XVt5iZ.js" as="script"><link rel="prefetch" href="/assets/index.html-B4z6VAdw.js" as="script"><link rel="prefetch" href="/assets/index.html-cM78LN2l.js" as="script"><link rel="prefetch" href="/assets/index.html-ThqWo8Sh.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-D2Nf-uDI.js" as="script"><link rel="prefetch" href="/assets/giscus-1zs_z9NH.js" as="script"><link rel="prefetch" href="/assets/searchBox-default-oZm0hqud.js" as="script"><link rel="prefetch" href="/assets/SearchBox-fA3meHCe.js" as="script"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-c0907686><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1224062b></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-1224062b> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-c0907686 data-v-0d7c8d3b><div class="vp-navbar" vp-navbar data-v-0d7c8d3b data-v-c3e1f628><div class="wrapper" data-v-c3e1f628><div class="container" data-v-c3e1f628><div class="title" data-v-c3e1f628><div class="vp-navbar-title" data-v-c3e1f628 data-v-7547ac60><a class="vp-link link no-icon title" href="/" data-v-7547ac60><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-6b7ad23c><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-6b7ad23c><!--]--><!--]--><!--]--><span data-v-7547ac60>Velvet-Notes</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-c3e1f628><div class="content-body" data-v-c3e1f628><!--[--><!--]--><div class="vp-navbar-search search" data-v-c3e1f628><div class="search-wrapper" data-v-617be9c3><!----><div id="local-search" data-v-617be9c3><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-617be9c3><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><!--[--><!--]--><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-c3e1f628 data-v-2c554402><span id="main-nav-aria-label" class="visually-hidden" data-v-2c554402>Main Navigation</span><!--[--><!--[--><a class="vp-link link navbar-menu-link" href="/" tabindex="0" data-v-2c554402 data-v-0f8fa3a5><!--[--><!----><span data-v-0f8fa3a5>首页</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/projlist/" tabindex="0" data-v-2c554402 data-v-0f8fa3a5><!--[--><!----><span data-v-0f8fa3a5>项目</span><!----><!--]--><!----></a><!--]--><!--[--><a class="vp-link link navbar-menu-link" href="/blog/" tabindex="0" data-v-2c554402 data-v-0f8fa3a5><!--[--><!----><span data-v-0f8fa3a5>博客</span><!----><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-2c554402 data-v-81423e5a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-81423e5a><span class="text" data-v-81423e5a><!----><!----><span data-v-81423e5a>灵感</span><!----><span class="vpi-chevron-down text-icon" data-v-81423e5a></span></span></button><div class="menu" data-v-81423e5a><div class="vp-menu" data-v-81423e5a data-v-3ea3c7a2><div class="items" data-v-3ea3c7a2><!--[--><!--[--><div class="vp-menu-group" data-v-3ea3c7a2 data-v-d0e2eee7><p class="title" data-v-d0e2eee7><!----><span data-v-d0e2eee7>Papers</span></p><!--[--><!--[--><div class="vp-menu-link" data-v-d0e2eee7 data-v-2646c5da><a class="vp-link link" href="https://arxiv.org/" target="_blank" rel="noreferrer" data-v-2646c5da><!--[--><!----> arXiv.org e-Print archive <!----><!--]--><span class="vpi-external-link"></span></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-d0e2eee7 data-v-2646c5da><a class="vp-link link" href="https://www.connectedpapers.com/" target="_blank" rel="noreferrer" data-v-2646c5da><!--[--><!----> CONNECTED PAPERS <!----><!--]--><span class="vpi-external-link"></span></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="vp-menu-group" data-v-3ea3c7a2 data-v-d0e2eee7><p class="title" data-v-d0e2eee7><!----><span data-v-d0e2eee7>Insights</span></p><!--[--><!--[--><div class="vp-menu-link" data-v-d0e2eee7 data-v-2646c5da><a class="vp-link link" href="https://soarxiv.org/" target="_blank" rel="noreferrer" data-v-2646c5da><!--[--><!----> soarXiv - the universe of science <!----><!--]--><span class="vpi-external-link"></span></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-2c554402 data-v-81423e5a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-81423e5a><span class="text" data-v-81423e5a><!----><!----><span data-v-81423e5a>笔记</span><!----><span class="vpi-chevron-down text-icon" data-v-81423e5a></span></span></button><div class="menu" data-v-81423e5a><div class="vp-menu" data-v-81423e5a data-v-3ea3c7a2><div class="items" data-v-3ea3c7a2><!--[--><!--[--><div class="vp-menu-group" data-v-3ea3c7a2 data-v-d0e2eee7><!----><!--[--><!--[--><div class="vp-menu-link" data-v-d0e2eee7 data-v-2646c5da><a class="vp-link link" href="/Memo/" data-v-2646c5da><!--[--><!----> 备忘录 <!----><!--]--><!----></a></div><!--]--><!--[--><div class="vp-menu-link" data-v-d0e2eee7 data-v-2646c5da><a class="vp-link link" href="/D2L/" data-v-2646c5da><!--[--><!----> Dive into Deep Learning <!----><!--]--><!----></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!--[--><!--]--><!----><div class="vp-navbar-appearance appearance" data-v-c3e1f628 data-v-ca84e07a><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-ca84e07a data-v-4fb4d2cf data-v-668778a2><span class="check" data-v-668778a2><span class="icon" data-v-668778a2><!--[--><span class="vpi-sun sun" data-v-4fb4d2cf></span><span class="vpi-moon moon" data-v-4fb4d2cf></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-c3e1f628 data-v-b24c63ab data-v-e2339aca><!--[--><a class="vp-social-link no-icon" href="https://github.com/Velvet0314" aria-label="github" target="_blank" rel="noopener" data-v-e2339aca data-v-675ac7ab><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-c3e1f628 data-v-385b85c2 data-v-81423e5a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-81423e5a><span class="vpi-more-horizontal icon" data-v-81423e5a></span></button><div class="menu" data-v-81423e5a><div class="vp-menu" data-v-81423e5a data-v-3ea3c7a2><!----><!--[--><!--[--><!----><div class="group" data-v-385b85c2><div class="item appearance" data-v-385b85c2><p class="label" data-v-385b85c2>外观</p><div class="appearance-action" data-v-385b85c2><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-385b85c2 data-v-4fb4d2cf data-v-668778a2><span class="check" data-v-668778a2><span class="icon" data-v-668778a2><!--[--><span class="vpi-sun sun" data-v-4fb4d2cf></span><span class="vpi-moon moon" data-v-4fb4d2cf></span><!--]--></span></span></button></div></div></div><div class="group" data-v-385b85c2><div class="item social-links" data-v-385b85c2><div class="vp-social-links social-links-list" data-v-385b85c2 data-v-e2339aca><!--[--><a class="vp-social-link no-icon" href="https://github.com/Velvet0314" aria-label="github" target="_blank" rel="noopener" data-v-e2339aca data-v-675ac7ab><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-c3e1f628 data-v-a01879b9><span class="container" data-v-a01879b9><span class="top" data-v-a01879b9></span><span class="middle" data-v-a01879b9></span><span class="bottom" data-v-a01879b9></span></span></button></div></div></div></div><div class="divider" data-v-c3e1f628><div class="divider-line" data-v-c3e1f628></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-c0907686 data-v-3ea7a05f><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-3ea7a05f><span class="vpi-align-left menu-icon" data-v-3ea7a05f></span><span class="menu-text" data-v-3ea7a05f>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-3ea7a05f data-v-89d45550><button data-v-89d45550>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-c0907686 data-v-8e6b0b1c><div class="vp-doc-container is-blog" data-v-8e6b0b1c data-v-ce8ab5ff><!--[--><!--]--><div class="container" data-v-ce8ab5ff><!----><div class="content" data-v-ce8ab5ff><div class="content-container" data-v-ce8ab5ff><!--[--><!--]--><main class="main" data-v-ce8ab5ff><nav class="vp-breadcrumb" data-v-ce8ab5ff data-v-f43771b3><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-f43771b3><!--[--><li property="itemListElement" typeof="ListItem" data-v-f43771b3><a class="vp-link link breadcrumb" href="/" property="item" typeof="WebPage" data-v-f43771b3><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-f43771b3></span><meta property="name" content="首页" data-v-f43771b3><meta property="position" content="1" data-v-f43771b3></li><li property="itemListElement" typeof="ListItem" data-v-f43771b3><a class="vp-link link breadcrumb" href="/blog/" property="item" typeof="WebPage" data-v-f43771b3><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-f43771b3></span><meta property="name" content="博客" data-v-f43771b3><meta property="position" content="2" data-v-f43771b3></li><li property="itemListElement" typeof="ListItem" data-v-f43771b3><a class="vp-link link breadcrumb" href="/blog/categories/?id=a566b2" property="item" typeof="WebPage" data-v-f43771b3><!--[-->papers<!--]--><!----></a><span class="vpi-chevron-right" data-v-f43771b3></span><meta property="name" content="papers" data-v-f43771b3><meta property="position" content="3" data-v-f43771b3></li><li property="itemListElement" typeof="ListItem" data-v-f43771b3><a class="vp-link link breadcrumb" href="/blog/categories/?id=c55bca" property="item" typeof="WebPage" data-v-f43771b3><!--[-->分子生成<!--]--><!----></a><span class="vpi-chevron-right" data-v-f43771b3></span><meta property="name" content="分子生成" data-v-f43771b3><meta property="position" content="4" data-v-f43771b3></li><li property="itemListElement" typeof="ListItem" data-v-f43771b3><a class="vp-link link breadcrumb current" href="/papers/%E5%88%86%E5%AD%90%E7%94%9F%E6%88%90/targetdiff" property="item" typeof="WebPage" data-v-f43771b3><!--[-->TargetDiff<!--]--><!----></a><!----><meta property="name" content="TargetDiff" data-v-f43771b3><meta property="position" content="5" data-v-f43771b3></li><!--]--></ol></nav><!--[--><!--]--><!--[--><h1 class="vp-doc-title page-title" data-v-b15de072>TargetDiff <!----></h1><div class="vp-doc-meta" data-v-b15de072><!--[--><!--]--><p class="reading-time" data-v-b15de072><span class="vpi-books icon" data-v-b15de072></span><span data-v-b15de072>约 3690 字</span><span data-v-b15de072>大约 12 分钟</span></p><p data-v-b15de072><span class="vpi-tag icon" data-v-b15de072></span><!--[--><a class="vp-link link tag vp-tag-d73v" href="/blog/tags/?tag=配体生成" data-v-b15de072><!--[-->配体生成<!--]--><!----></a><a class="vp-link link tag vp-tag-t35h" href="/blog/tags/?tag=扩散模型" data-v-b15de072><!--[-->扩散模型<!--]--><!----></a><!--]--></p><!--[--><!--]--><p class="create-time" data-v-b15de072><span class="vpi-clock icon" data-v-b15de072></span><span data-v-b15de072>2024-12-23</span></p></div><!--]--><!--[--><!--]--><div class="_papers_%E5%88%86%E5%AD%90%E7%94%9F%E6%88%90_targetdiff external-link-icon-enabled vp-doc plume-content" vp-content data-v-ce8ab5ff><!--[--><!--]--><div data-v-ce8ab5ff><h2 id="targetdiff-概述" tabindex="-1"><a class="header-anchor" href="#targetdiff-概述"><span><strong>TargetDiff 概述</strong></span></a></h2><h3 id="targetdiff-在干什么" tabindex="-1"><a class="header-anchor" href="#targetdiff-在干什么"><span><strong>TargetDiff 在干什么</strong></span></a></h3><p>TargetDiff是一种基于三维等变扩散模型的分子生成工具，专注于目标蛋白感知的分子设计和结合亲和力预测，旨在加速药物发现进程。其核心应用包括：</p><ol><li><p><mark class="note"><strong>靶向分子生成：根据目标蛋白的三维结合口袋结构，生成与之空间匹配且具有高结合亲和力的候选分子（例如小分子配体）</strong></mark></p></li><li><p><mark class="note"><strong>结合亲和力预测</strong>：通过无监督特征提取，提供分子与靶点蛋白的结合强度估计，辅助药物筛选</mark></p></li><li><p>分子结构优化：生成具有合理三维构象的分子，避免传统方法（如自回归模型）因逐步生成导致的几何失真问题</p></li></ol><h3 id="targetdiff-解决的问题" tabindex="-1"><a class="header-anchor" href="#targetdiff-解决的问题"><span><strong>TargetDiff 解决的问题</strong></span></a></h3><table><thead><tr><th>🚀 问题类别</th><th>❌ 传统方法的局限</th><th>✅ TargetDiff 的解决方案</th></tr></thead><tbody><tr><td><strong>几何约束建模不足</strong></td><td>🚨 基于体素化密度或自回归采样，常生成不合理的键长、键角，刚性片段（如苯环）易扭曲，结构失真</td><td>✨ 采用 <strong>SE(3)-等变扩散模型</strong>，保证生成结构在旋转/平移下几何一致，自动对齐结合位点，避免失真</td></tr><tr><td><strong>三维等变性缺失</strong></td><td>🚨 忽略分子与靶点之间的相对空间关系，生成构象与蛋白结合口袋匹配性差</td><td>✨ 利用 <strong>等变神经网络</strong> 建模，天然保持三维旋转、平移等变性，提高结合构象的空间合理性</td></tr><tr><td><strong>标注数据依赖性强</strong></td><td>🚨 亲和力预测依赖大量标注数据，数据昂贵且难以获取</td><td>✨ 通过 <strong>无监督学习提取分子-靶点复合物的隐含表示</strong>，降低对监督数据依赖</td></tr><tr><td><strong>生成效率低下</strong></td><td>🚨 自回归方法需逐步生成原子，随分子尺寸增长时间成本快速上升</td><td>✨ <strong>扩散模型并行生成所有原子</strong>，显著提升大分子生成效率</td></tr><tr><td><strong>位置与类型分离生成</strong></td><td>🚨 原子位置与类型分离生成，可能导致物理结构不一致</td><td>✨ 通过 <strong>联合生成坐标与类型</strong> 的扩散流程，同时优化结构和类型，增强物理合理性</td></tr><tr><td><strong>功能单一，泛化弱</strong></td><td>🚨 大多数模型仅用于生成或预测，特征泛化能力弱</td><td>✨ TargetDiff 同时作为 <strong>分子生成器 + 无监督特征提取器</strong>，用于结合亲和力排名与预测，效果超越EGNN</td></tr><tr><td><strong>评估标准不全面</strong></td><td>🚨 传统评估指标如 RMSD 或 Tanimoto 不能全面反映三维构象质量</td><td>✨ 引入 <strong>刚性片段一致性 RMSD</strong> 和 <strong>键距 JS 散度</strong> 等新指标，更好量化结构真实性与物理合理性</td></tr></tbody></table><h3 id="targetdiff-尚未解决的问题" tabindex="-1"><a class="header-anchor" href="#targetdiff-尚未解决的问题"><span><strong>TargetDiff 尚未解决的问题</strong></span></a></h3><ol><li><p><mark class="danger"><strong>化学键生成的依赖性：</strong></mark> 当前模型依赖后处理工具（如OpenBabel）推断化学键，可能引入误差。未来需将键生成直接纳入扩散过程</p></li><li><p><mark class="danger"><strong>可合成性与药物相似性不足：</strong></mark> 在QED（药物相似性）和SA（可合成性）评分上落后于Pocket2Mol，需通过 <mark class="note"><strong>片段生成技术优化分子子结构</strong></mark></p></li><li><p><mark class="danger"><strong>立体冲突问题：</strong></mark> 生成的分子可能 <mark class="warning"><strong>因原子间距过近导致立体冲突（clash）</strong></mark>，需 <mark class="note"><strong>引入最小距离约束或后处理优化</strong></mark></p></li><li><p>采样速度与精度权衡： 原始DDPM采样需1000步，虽可通过DPM-Solver++加速至10步，但可能牺牲结合亲和力；需进一步优化采样算法</p></li><li><p>多目标优化挑战： 在同时优化结合亲和力、药物相似性和多样性时存在权衡（如ALIDIFF实验显示低 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span> 值增强亲和力但降低 QED）</p></li></ol><h2 id="targetdiff-理论" tabindex="-1"><a class="header-anchor" href="#targetdiff-理论"><span><strong>TargetDiff 理论</strong></span></a></h2><h3 id="targetdiff-原理简述" tabindex="-1"><a class="header-anchor" href="#targetdiff-原理简述"><span><strong>TargetDiff 原理简述</strong></span></a></h3><h4 id="生成模型" tabindex="-1"><a class="header-anchor" href="#生成模型"><span><strong>生成模型</strong></span></a></h4><ul><li>学习一个分布 distribution —— 如何学习？ <ul><li>已知一个简单的分布（高斯分布、均匀分布...），从中采样（sample）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span></li><li>利用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mi>e</mi><mi>t</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mtext> </mtext><mi>G</mi></mrow><annotation encoding="application/x-tex">Network\ G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">tw</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace"> </span><span class="mord mathnormal">G</span></span></span></span> 将简单分布映射到一个复杂分布</li><li>生成样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">G(z)=y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 近似于复杂分布（我们无法从复杂分布中直接采样）</li></ul></li><li>利用学习到的分布，从中采样得到结果</li></ul><h4 id="ddpm" tabindex="-1"><a class="header-anchor" href="#ddpm"><span><strong>DDPM</strong></span></a></h4><h5 id="denoising-diffusion-probabilistic-models-去噪扩散概率模型" tabindex="-1"><a class="header-anchor" href="#denoising-diffusion-probabilistic-models-去噪扩散概率模型"><span><strong>Denoising Diffusion Probabilistic Models 去噪扩散概率模型</strong></span></a></h5><h5 id="核心思想" tabindex="-1"><a class="header-anchor" href="#核心思想"><span><strong>核心思想</strong></span></a></h5><ul><li><strong>前向扩散过程（Forward Diffusion Process）</strong><ul><li>逐步加噪，记录噪声和中间产物，训练网络预测噪声</li></ul></li><li><strong>反向去噪过程（Reverse Denoising Process）</strong><ul><li>从纯噪声开始，逐步去噪，恢复出想要的目标数据</li></ul></li></ul><h3 id="targetdiff-训练算法流程" tabindex="-1"><a class="header-anchor" href="#targetdiff-训练算法流程"><span><strong>TargetDiff 训练算法流程</strong></span></a></h3><div class="vp-steps"><ol><li><p>输入：蛋白质-配体的结合数据集</p></li><li><p>扩散条件初始化：采样时间步 —— 从均匀分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>T</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">U(0, \dots, T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mclose">)</span></span></span></span> 中采样扩散时间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></p></li><li><p>预处理：将蛋白质原子的质心移动到原点，以对齐配体和蛋白质的位置，确保数据在空间上的一致性</p></li><li><p>加噪：网络中主要是针对 位置 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 和 原子类型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> 进行扰动，逐步加噪</p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub><mo>=</mo><msqrt><msub><mover accent="true"><mi>α</mi><mo>ˉ</mo></mover><mi>t</mi></msub></msqrt><msub><mi>x</mi><mn>0</mn></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mover accent="true"><mi>α</mi><mo>ˉ</mo></mover><mi>t</mi></msub><mo stretchy="false">)</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">x_t = \sqrt{\bar{\alpha}_t} x_0 + (1 - \bar{\alpha}_t) \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.2461em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7939em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7539em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2461em;"><span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">ϵ</span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">ϵ</span></span></span></span>  是从正态分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(0, I)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mclose">)</span></span></span></span>  中采样的噪声</li><li><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mi mathvariant="bold">c</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>log</mi><mo>⁡</mo><mrow><mo fence="true">(</mo><msub><mover accent="true"><mi>α</mi><mo>ˉ</mo></mover><mi>t</mi></msub><msub><mi mathvariant="bold">v</mi><mn>0</mn></msub><mo>+</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mover accent="true"><mi>α</mi><mo>ˉ</mo></mover><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><mi>K</mi></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr><mtr><mtd class="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mtext>one_hot</mtext><mrow><mo fence="true">(</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>i</mi></munder><mo stretchy="false">[</mo><msub><mi>g</mi><mi>i</mi></msub><mo>+</mo><mi>log</mi><mo>⁡</mo><msub><mi>c</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mtext> where </mtext><mi>g</mi><mo>∼</mo><mtext>Gumbel</mtext><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class="mtr-glue"></mtd><mtd class="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}log \mathbf{c} &amp;= \log \left( \bar{\alpha}_t \mathbf{v}_0 + \frac{(1 - \bar{\alpha}_t)}{K} \right) \\ \mathbf{v}_t &amp;= \text{one\_hot} \left( \arg \max_i [g_i + \log c_i] \right), \text{ where } g \sim \text{Gumbel}(0, 1)\end{align} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.8777em;vertical-align:-2.1888em;"></span><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6888em;"><span style="top:-4.6888em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathbf">c</span></span></span><span style="top:-2.2888em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1888em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6888em;"><span style="top:-4.6888em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span><span style="top:-2.2888em;"><span class="pstrut" style="height:3.45em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">one_hot</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3723em;margin-left:0em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7277em;"><span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord"> where </span></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord text"><span class="mord">Gumbel</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1888em;"><span></span></span></span></span></span></span></span><span class="tag"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6888em;"><span style="top:-4.6888em;"><span class="pstrut" style="height:3.45em;"></span><span class="eqn-num"></span></span><span style="top:-2.2888em;"><span class="pstrut" style="height:3.45em;"></span><span class="eqn-num"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1888em;"><span></span></span></span></span></span></span></span></span></p></li></ul></li><li><p>预测：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mn>0</mn></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">]</mo><mo>=</mo><msub><mi>ϕ</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>x</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>t</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>t</mi><mo separator="true">,</mo><mi mathvariant="script">P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[\hat{x}_0,\hat{v}_0]=\phi_\theta([xt, vt], t, \mathcal{P})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">P</span><span class="mclose">)</span></span></span></span> ，预测扰动位置和类型，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat{x}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>  和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat{v}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，条件是当前的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">x_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、时间步 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> 和蛋白质信息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">P</mi></mrow><annotation encoding="application/x-tex">\mathcal{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">P</span></span></span></span></p></li><li><p>计算后验类型分布：根据公式计算原子类型的后验分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c(v_t, v_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo stretchy="false">(</mo><msub><mi>v</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c(v_t, \hat{v}_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p></li><li><p>损失函数：</p><ul><li>均方误差 MSE：度量原子坐标的偏差</li><li>KL 散度（KL-divergence）：度量类型分布的差异</li></ul></li><li><p>更新参数： 最小化损失函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">L</span></span></span></span>  来更新模型参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></p></li></ol></div><div class="vp-image-card center" style="width:85%;" data-v-4316d14c><div class="image-container" data-v-4316d14c><img src="https://image.velvet-notes.org/blog/train_targetdiff.png" loading="lazy" data-v-4316d14c><!----></div></div><h3 id="targetdiff-采样算法流程" tabindex="-1"><a class="header-anchor" href="#targetdiff-采样算法流程"><span><strong>TargetDiff 采样算法流程</strong></span></a></h3><div class="vp-steps"><ol><li><p>输入：蛋白质结合位点（binding site）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">P</mi></mrow><annotation encoding="application/x-tex">\mathcal{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">P</span></span></span></span> 与 训练好的模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϕ</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\phi_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p></li><li><p>输出：由模型生成的能与蛋白质口袋结合的配体分子 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">M</mi></mrow><annotation encoding="application/x-tex">\mathcal{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal">M</span></span></span></span></p></li><li><p>确定原子数量：基于口袋大小，从一个先验分布中采样一个生成的配体分子的原子数量</p></li><li><p>预处理：移动蛋白质原子的质心至坐标原点，使位置标准化，以确保生成的配体与蛋白质结合位点对齐</p></li><li><p>初始化：采样一个初始的原子坐标（coordinates）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 原子类型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{v}_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><ul><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi>T</mi></msub><mo>∈</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="bold-italic">I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{x}_T \in \mathcal{N}(0,\boldsymbol{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.07778em;">I</span></span></span><span class="mclose">)</span></span></span></span> —— 从标准正态分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="bold-italic">I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(0,\boldsymbol{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.07778em;">I</span></span></span><span class="mclose">)</span></span></span></span> 中采样</li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mi>T</mi></msub><mo>=</mo><mtext>one_hot</mtext><mrow><mo fence="true">(</mo><mi>arg</mi><mo>⁡</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>i</mi></msub><msub><mi>g</mi><mi>i</mi></msub><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mtext> where </mtext><mi>g</mi><mo>∼</mo><mtext>Gumbel</mtext><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{v}_T = \text{one\_hot} \left( \arg \max_i g_i \right), \text{ where } g \sim \text{Gumbel}(0, 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"></span><span class="mord text"><span class="mord">one_hot</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord text"><span class="mord"> where </span></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Gumbel</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></li><li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="bold">for</mtext><mtext> </mtext><mi>t</mi><mtext> in </mtext><mi>T</mi><mo separator="true">,</mo><mi>T</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><mn>1</mn><mtext> </mtext><mtext mathvariant="bold">do</mtext></mrow><annotation encoding="application/x-tex">\textbf{for}\ t\ \text{in}\ T,T-1,\cdots,1\ \textbf{do}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord text"><span class="mord textbf">for</span></span><span class="mspace"> </span><span class="mord mathnormal">t</span><span class="mspace"> </span><span class="mord text"><span class="mord">in</span></span><span class="mspace"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mspace"> </span><span class="mord text"><span class="mord textbf">do</span></span></span></span></span> （反向去噪）</li></ul></li><li><p>预测：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mn>0</mn></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">]</mo><mo>=</mo><msub><mi>ϕ</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>x</mi><mi>t</mi><mo separator="true">,</mo><mi>v</mi><mi>t</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>t</mi><mo separator="true">,</mo><mi mathvariant="script">P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">[\hat{x}_0,\hat{v}_0]=\phi_\theta([xt, vt], t, \mathcal{P})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">t</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">P</span><span class="mclose">)</span></span></span></span> ，预测扰动位置和类型，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat{x}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>  和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\hat{v}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ，条件是当前的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">x_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">v_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>、时间步 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> 和蛋白质信息 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">P</mi></mrow><annotation encoding="application/x-tex">\mathcal{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathcal" style="margin-right:0.08222em;">P</span></span></span></span></p></li><li><p>根据后验分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>x</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_\theta(x_{t-1} | x_t, \hat{x}_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 对原子位置 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_{t-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6528em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span>进行采样</p></li><li><p>根据后验分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>v</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>v</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mover accent="true"><mi>v</mi><mo>^</mo></mover><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_\theta(v_{t-1} | v_t, \hat{v}_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2222em;"><span class="mord">^</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 对原子类型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{v}_{t-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6528em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span></span></span></span> 进行采样</p></li></ol></div><div class="vp-image-card center" style="width:85%;" data-v-4316d14c><div class="image-container" data-v-4316d14c><img src="https://image.velvet-notes.org/blog/sample_targetdiff.png" loading="lazy" data-v-4316d14c><!----></div></div><h2 id="targetdiff-代码" tabindex="-1"><a class="header-anchor" href="#targetdiff-代码"><span><strong>TargetDiff 代码</strong></span></a></h2><h3 id="代码解读" tabindex="-1"><a class="header-anchor" href="#代码解读"><span><strong>代码解读</strong></span></a></h3><p><a href="https://github.com/Velvet0314/targetdiff/tree/4LearnOnly" target="_blank" rel="noopener noreferrer">Velvet0314/targetdiff at 4LearnOnly</a></p><h3 id="环境安装-tips" tabindex="-1"><a class="header-anchor" href="#环境安装-tips"><span><strong>环境安装 Tips</strong></span></a></h3><ul><li>推荐在 Linux 下进行环境安装（可以用 WSL） —— Vina 需要 Linux 环境</li><li>注意 Pytorch, Cuda, Python 的版本对应</li><li>需要安装对应版本的 cudatoolkit 实现 Pytorch 中利用 cuda 进行 GPU 的加速</li><li>我的环境在 <code>myenvironment.yaml</code> 中，可以跑通</li></ul><h3 id="额外内容" tabindex="-1"><a class="header-anchor" href="#额外内容"><span><strong>额外内容</strong></span></a></h3><ul><li>test_cuda.py 用于测试 cuda 是否启用</li><li>viewlmdb.py 用于可视化输入数据</li></ul><h3 id="训练流程" tabindex="-1"><a class="header-anchor" href="#训练流程"><span><strong>训练流程</strong></span></a></h3><p>主要代码在 <code>train_diffusion.py</code>和<code>molopt_score_model.py</code>中</p><div class="vp-steps"><ol><li><p>解析命令行 —— 训练的超参数的设置</p></li><li><p>数据的预处理 —— 数据输入的预处理</p><ul><li>主要是进行数据的映射与反映射</li></ul></li><li><p>数据集处理 —— 数据加载与划分</p></li><li><p>初始化模型 —— 调用<code>molopt_score_model.py</code>中的模型</p></li><li><p>训练 —— 关键在 <code>model.get_diffusion_loss</code> 函数中</p><div class="vp-steps"><ol><li>生成时间步 —— 算法step2<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># sample noise levels</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> time_step </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">is</span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;"> None</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	time_step, pt </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.sample_time(num_graphs, protein_pos.device, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.sample_time_method)</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pt </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.ones_like(time_step).float() </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">/</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.num_timesteps</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	a </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.alphas_cumprod.index_select(</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">0</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, time_step)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># (num_graphs, )</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>质心归零 —— 算法step3<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_pos, ligand_pos, _ </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> center_pos(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_pos, ligand_pos, batch_protein, batch_ligand, mode</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.center_pos_mode)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li>对 原子位置 pos &amp; 原子类型 v 进行加噪 —— 算法step4&amp;5<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># perturb pos and v</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">a_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> a[batch_ligand].unsqueeze(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># (num_ligand_atoms, 1)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos_noise </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.zeros_like(ligand_pos)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos_noise.normal_()</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># Xt = a.sqrt() * X0 + (1-a).sqrt() * eps</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_perturbed </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> a_pos.sqrt() </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">*</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> (</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1.0</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> -</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> a_pos).sqrt() </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">*</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_noise  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># pos_noise * std</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># Vt = a * V0 + (1-a) / K</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_ligand_v0 </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> index_to_log_onehot(ligand_v, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.num_classes)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_v_perturbed, log_ligand_vt </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_v_sample(log_ligand_v0, time_step, batch_ligand)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>前向传播计算，得到每阶段加噪的结果和网络预测的噪声 —— 算法step6<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># forward-pass NN, feed perturbed pos and v, output noise</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">preds </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_pos</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_pos,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_v</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_v,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_protein</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_protein,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_pos</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_perturbed,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_v</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_v_perturbed,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_ligand</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	time_step</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_step</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pred_ligand_pos, pred_ligand_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_pos&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">], preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_v&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 网络预测的噪声</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pred_pos_noise </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pred_ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos_perturbed</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># atom position</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;noise&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pos0_from_e </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">._predict_x0_from_eps(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		xt</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_perturbed, eps</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pred_pos_noise, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_step, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pos_model_mean </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_pos_posterior(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		x0</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos0_from_e, xt</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_perturbed, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_step, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">elif</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;C0&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pos_model_mean </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_pos_posterior(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		x0</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pred_ligand_pos, xt</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_perturbed, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_step, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	raise</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> ValueError</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>计算后验分布与误差 —— 算法step7&amp;8<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># atom pos loss</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;C0&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	target, pred </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos, pred_ligand_pos</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">elif</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;noise&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	target, pred </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_noise, pred_pos_noise</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	raise</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> ValueError</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">loss_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> scatter_mean(((pred </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> target) </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">**</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 2</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">).sum(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">), batch_ligand, dim</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">0</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">loss_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.mean(loss_pos)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># atom type loss</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_ligand_v_recon </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> F.log_softmax(pred_ligand_v, dim</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_v_model_prob </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_v_posterior(log_ligand_v_recon, log_ligand_vt, time_step, batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_v_true_prob </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_v_posterior(log_ligand_v0, log_ligand_vt, time_step, batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">kl_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.compute_v_Lt(log_v_model_prob</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_v_model_prob, log_v0</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_ligand_v0,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	log_v_true_prob</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">log_v_true_prob, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_step, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">loss_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.mean(kl_v)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">loss </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> loss_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> loss_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">*</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.loss_v_weight</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></div></li></ol></div><h3 id="采样流程" tabindex="-1"><a class="header-anchor" href="#采样流程"><span><strong>采样流程</strong></span></a></h3><p>主要代码在 <code>sample_diffusion.py</code>和<code>molopt_score_model.py</code>中</p><div class="vp-steps"><ol><li><p>解析命令行 —— 采样的超参数的设置</p></li><li><p>加载训练好的模型 —— ckpt -&gt; checkpoint</p></li><li><p>数据的预处理 —— 采用和模型训练时的相同的处理（所有的 config 均来自于选取的模型的训练时的配置）</p></li><li><p>初始化模型 —— 调用<code>molopt_score_model.py</code>中的模型</p></li><li><p>采样 —— 关键在 <code>sample_diffusion_ligand</code> 函数 和 <code>model.sample_diffusion</code> 函数中</p><div class="vp-steps"><ol><li>确定原子数量 —— 算法step1<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤一：确定原子数量</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 这里有三种方式，其中第一种对应算法中的步骤</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sample_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;prior&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 根据先验分布采样配体原子数量</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pocket_size </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> atom_num.get_space_size(data.protein_pos.detach().cpu().numpy())  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 计算口袋大小</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	ligand_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> [atom_num.sample_atom_num(pocket_size).astype(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">int</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">) </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> _ </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(n_data)]  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 采样原子数量</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_ligand </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.repeat_interleave(torch.arange(n_data), torch.tensor(ligand_num_atoms)).to(device)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 生成配体批次索引</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">elif</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sample_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;range&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 按顺序指定配体原子数量</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	ligand_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> list</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(current_i </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, current_i </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> n_data </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">))  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 生成原子数量列表</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_ligand </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.repeat_interleave(torch.arange(n_data), torch.tensor(ligand_num_atoms)).to(device)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 生成配体批次索引</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">elif</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sample_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;ref&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 使用参考数据的原子数量</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_ligand </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> batch.ligand_element_batch  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 获取配体的批次索引</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	ligand_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> scatter_sum(torch.ones_like(batch_ligand), batch_ligand, dim</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">0</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">).tolist()  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 计算每个样本的原子数量</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	    </span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	raise</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> ValueError</span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">  # 抛出异常</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>质心归零 —— 算法step2<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤二：初始化配体位置</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">center_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> scatter_mean(batch.protein_pos, batch_protein, dim</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">0</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 计算每个蛋白质的中心位置</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_center_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> center_pos[batch_ligand]  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 获取每个配体原子的中心位置</span></span>
<span class="line"><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">...</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_pos, init_ligand_pos, offset </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> center_pos(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_pos, init_ligand_pos, batch_protein, batch_ligand, mode</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">center_pos_mode)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>采样初始化 —— 算法step3<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤三：采样初始化——原子位置</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">init_ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> batch_center_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.randn_like(batch_center_pos)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 添加随机噪声，初始化配体位置</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤三：采样初始化—原子类型</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_only:</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 如果仅采样位置，使用初始的配体特征</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> batch.ligand_atom_feature_full</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 否则，从均匀分布中采样初始v值</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# 算法中对应的步骤</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	uniform_logits </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.zeros(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">len</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(batch_ligand), model.num_classes).to(device)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 创建均匀分布的logits</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> log_sample_categorical(uniform_logits)  </span><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 采样v值</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>反转时间步 —— 算法step4<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># time sequence</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 反转时间步，从 T-1 到 0</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">time_seq </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> list</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">reversed</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.num_timesteps </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> num_steps, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.num_timesteps)))</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>预测 —— 算法step5<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤五：从时间步 T 开始使用模型 ϕ₀ 从 [xₜ, vₜ] 预测 [x̂₀, v̂₀]</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># self() 调用前向传播 forward()</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">preds </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_pos</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_pos,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_v</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">protein_v,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_protein</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_protein,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_pos</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	init_ligand_v</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_v,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	batch_ligand</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	time_step</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">t</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># Compute posterior mean and variance</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;noise&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pred_pos_noise </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_pos&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pos0_from_e </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">._predict_x0_from_eps(xt</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos, eps</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pred_pos_noise, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">t, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	v0_from_e </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_v&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">elif</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.model_mean_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;C0&#39;</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pos0_from_e </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_pos&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	v0_from_e </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> preds[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pred_ligand_v&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	raise</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> ValueError</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>采样下一时间步的 原子位置 与 原子类型 —— 算法step6&amp;7<div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 步骤六&amp;七：由后验分布采样 [xₜ₋₁, vₜ₋₁]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos_model_mean </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_pos_posterior(x0</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos0_from_e, xt</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos, t</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">t, batch</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos_log_variance </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> extract(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.posterior_logvar, t, batch_ligand)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># no noise when t == 0</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">nonzero_mask </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> (</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> -</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> (t </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">==</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 0</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">).float())[batch_ligand].unsqueeze(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos_next </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_model_mean </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> nonzero_mask </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">*</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> (</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">0.5</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> *</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_log_variance).exp() </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">*</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> torch.randn_like(ligand_pos)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos_next</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># 若不只是采样位置，则采样原子类型 vₜ₋₁</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">if</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> not</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos_only:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	log_ligand_v_recon </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> F.log_softmax(v0_from_e, dim</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	log_ligand_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> index_to_log_onehot(ligand_v, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.num_classes)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	log_model_prob </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.q_v_posterior(log_ligand_v_recon, log_ligand_v, t, batch_ligand)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	ligand_v_next </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> log_sample_categorical(log_model_prob)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	v0_pred_traj.append(log_ligand_v_recon.clone().cpu())</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	vt_pred_traj.append(log_model_prob.clone().cpu())</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	ligand_v </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_v_next</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ori_ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> offset[batch_ligand]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">pos_traj.append(ori_ligand_pos.clone().cpu())</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">v_traj.append(ligand_v.clone().cpu())</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol></div></li></ol></div><h3 id="评估流程" tabindex="-1"><a class="header-anchor" href="#评估流程"><span><strong>评估流程</strong></span></a></h3><p>主要在<code>evaluate_diffusion.py</code> 和 <code>evaluate_from_meta.py</code> 中</p><p>评估流程整体上就是对一些指标进行计算来衡量生成分子的好坏</p><h4 id="jensen-shannon-divergence-between-the-distributions-of-bond-distance" tabindex="-1"><a class="header-anchor" href="#jensen-shannon-divergence-between-the-distributions-of-bond-distance"><span>Jensen-Shannon divergence between the distributions of bond distance</span></a></h4><p>主要在 <code>eval_bond_length.py</code> 中</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> bond_distance_from_mol</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(mol):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	   pos </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> mol.GetConformer().GetPositions()</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pdist </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos[</span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;">None</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, :] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pos[:, </span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;">None</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pdist </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> np.sqrt(np.sum(pdist </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">**</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 2</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, axis</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">))</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	all_distances </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> []</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> mol.GetBonds():</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		s_sym </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond.GetBeginAtom().GetAtomicNum()</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		e_sym </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond.GetEndAtom().GetAtomicNum()</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		s_idx, e_idx </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond.GetBeginAtomIdx(), bond.GetEndAtomIdx()</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		bond_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> utils_data.</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">BOND_TYPES</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">[bond.GetBondType()]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		distance </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pdist[s_idx, e_idx]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		all_distances.append(((s_sym, e_sym, bond_type), distance))</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> all_distances</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="distribution-for-distances-of-all-atom-and-carbon-carbon-pairs" tabindex="-1"><a class="header-anchor" href="#distribution-for-distances-of-all-atom-and-carbon-carbon-pairs"><span>Distribution for distances of all atom and carbon-carbon pairs</span></a></h4><p>主要在 <code>eval_bond_length.py</code> 中</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">c_bond_length_profile </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length.get_bond_length_profile(all_bond_dist)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">c_bond_length_dict </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length.eval_bond_length_profile(c_bond_length_profile)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">logger.info(</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;JS bond distances of complete mols: &#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">print_dict(c_bond_length_dict, logger)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">success_pair_length_profile </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length.get_pair_length_profile(success_pair_dist)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">success_js_metrics </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length.eval_pair_length_profile(success_pair_length_profile)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">print_dict(success_js_metrics, logger)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">atom_type_js </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_atom_type.eval_atom_type_distribution(success_atom_types)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">logger.info(</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;Atom type JS: </span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">%.4f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> %</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> atom_type_js)</span></span>
<span class="line"><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">...</span></span>
<span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> eval_bond_length_profile</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(bond_length_profile: BondLengthProfile) -&gt; Dict[</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">str</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, Optional[</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">float</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">]]:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	metrics </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> {}</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# Jensen-Shannon distances</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond_type, gt_distribution </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length_config.</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">EMPIRICAL_DISTRIBUTIONS</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.items():</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond_type </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">not</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> bond_length_profile:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">			metrics[</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;JSD_</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">_bond_type_str(bond_type)</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;"> None</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">			metrics[</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;JSD_</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">_bond_type_str(bond_type)</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sci_spatial.distance.jensenshannon(gt_distribution,                                                bond_length_profile[bond_type])</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> metrics</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> eval_pair_length_profile</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(pair_length_profile):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	metrics </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> {}</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> k, gt_distribution </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> eval_bond_length_config.</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">PAIR_EMPIRICAL_DISTRIBUTIONS</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.items():</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> k </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">not</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pair_length_profile:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">			metrics[</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;JSD_</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">k</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;"> None</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		else</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">			metrics[</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;JSD_</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">k</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sci_spatial.distance.jensenshannon(gt_distribution, pair_length_profile[k])</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> metrics</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> eval_atom_type_distribution</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(pred_counter: Counter):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	total_num_atoms </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> sum</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(pred_counter.values())</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	pred_atom_distribution </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> {}</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> k </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> ATOM_TYPE_DISTRIBUTION</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		pred_atom_distribution[k] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> pred_counter[k] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">/</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> total_num_atoms</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# print(&#39;pred atom distribution: &#39;, pred_atom_distribution)</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# print(&#39;ref  atom distribution: &#39;, ATOM_TYPE_DISTRIBUTION)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	js </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> sci_spatial.distance.jensenshannon(np.array(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">list</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">ATOM_TYPE_DISTRIBUTION</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.values())),</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">												np.array(</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">list</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(pred_atom_distribution.values())))</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> js</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="percentage-of-different-ring-sizes" tabindex="-1"><a class="header-anchor" href="#percentage-of-different-ring-sizes"><span>Percentage of different ring sizes</span></a></h4><p>主要在 <code>evaluate_diffusion.py</code> 中</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> print_ring_ratio</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(all_ring_sizes, logger):</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ring_size </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">3</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">10</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		n_mol </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 0</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> counter </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> all_ring_sizes:</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">			if</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ring_size </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> counter:</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">				n_mol </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 1</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">		logger.info(</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;ring size: </span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ring_size</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> ratio: </span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">n_mol </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">/</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> len</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(all_ring_sizes)</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">:.3f</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;"># check ring distribution</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">print_ring_ratio([r[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;chem_results&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">][</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;ring_size&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> r </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> results], logger)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="high-affinity" tabindex="-1"><a class="header-anchor" href="#high-affinity"><span>High Affinity</span></a></h4><p>主要在 <code>docking_vina.py</code>. 和 <code>docking_qvina.py</code> 中</p><h5 id="docking-mode-的选择" tabindex="-1"><a class="header-anchor" href="#docking-mode-的选择"><span><code>docking_mode</code> <strong>的选择</strong></span></a></h5><ul><li><p><code>evaluation_from_meta.py</code><code>docking_mode</code> 是默认的 <code>vina_full</code> 模式：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">parser.add_argument(</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;--docking_mode&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, type</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=str</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, default</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_full&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">					choices</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;none&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;qvina&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_full&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_score&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>evaluation_diffusion.py</code> 取决于命令行里的参数：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">parser.add_argument(</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;--docking_mode&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, type</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=str</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, default</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_full&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">,</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">					choices</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">[</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;qvina&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_score&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina_dock&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;none&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>参考的命令行：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">python</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> scripts/evaluate_diffusion.py</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> {OUTPUT_DIR}</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> --docking_mode</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> vina_score</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;"> --protein_root</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> data/test_set</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ul><h5 id="affinity-的计算" tabindex="-1"><a class="header-anchor" href="#affinity-的计算"><span><strong>Affinity 的计算</strong></span></a></h5><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> run</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(self, mode</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;dock&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, exhaustiveness</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">8</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">**</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">kwargs):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  		</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	ligand_pdbqt </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.ligand_path[:</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">4</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;.pdbqt&#39;</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	protein_pqr </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.receptor_path[:</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">4</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;.pqr&#39;</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	protein_pdbqt </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.receptor_path[:</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">-</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">4</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">] </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> &#39;.pdbqt&#39;</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	lig </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> PrepLig(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.ligand_path, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;sdf&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	lig.get_pdbqt(ligand_pdbqt)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	prot </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> PrepProt(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.receptor_path)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">  	if</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> not</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> os.path.exists(protein_pqr):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  		prot.addH(protein_pqr)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  		</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">  	if</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> not</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> os.path.exists(protein_pdbqt):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  		prot.get_pdbqt(protein_pdbqt)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">      </span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	dock </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> VinaDock(ligand_pdbqt, protein_pdbqt)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	dock.pocket_center, dock.box_size </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.center, [</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.size_x, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.size_y, </span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">self</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">.size_z]</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">  	score, pose </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> dock.dock(score_func</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;vina&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, mode</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">mode, exhaustiveness</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">exhaustiveness, save_pose</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#B58900;--shiki-dark:#B58900;">True</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">**</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">kwargs)</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">  	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> [{</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;affinity&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">: score, </span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&#39;pose&#39;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">: pose}]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="diversity" tabindex="-1"><a class="header-anchor" href="#diversity"><span><strong>Diversity</strong></span></a></h4><p>TargetDiff 中无该部分代码，但是单独给出一个用于计算 Diversity 的标准代码</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-light:#657B83;--shiki-dark:#839496;--shiki-light-bg:#FDF6E3;--shiki-dark-bg:#002B36;"><pre class="shiki shiki-themes solarized-light solarized-dark vp-code"><code class="language-python"><span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> tanimoto_sim</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(mol, ref):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	fp1 </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> Chem.RDKFingerprint(ref)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	fp2 </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> Chem.RDKFingerprint(mol)</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> DataStructs.TanimotoSimilarity(fp1,fp2)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> calc_pairwise_sim</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(mols):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	n </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> len</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(mols)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	sims </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> []</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	 for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> i </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(n):</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">		for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> j </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> range</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(i </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">+</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;"> 1</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">, n):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">			sims.append(tanimoto_sim(mols[i], mols[j]))</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> np.array(sims)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	</span></span>
<span class="line"><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">def</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;"> computer_diversity</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(mols):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	div_all </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> []</span></span>
<span class="line"><span style="--shiki-light:#93A1A1;--shiki-light-font-style:italic;--shiki-dark:#586E75;--shiki-dark-font-style:italic;">	# for result in tqdm(results):</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	div_all.append(np.mean(</span><span style="--shiki-light:#D33682;--shiki-dark:#D33682;">1</span><span style="--shiki-light:#859900;--shiki-dark:#859900;"> -</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> calc_pairwise_sim(mols)))</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	div_all </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> np.array(div_all)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	div_all </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> div_all[</span><span style="--shiki-light:#859900;--shiki-dark:#859900;">~</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">np.isnan(div_all)]</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">	return</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> div_all</span></span>
<span class="line"><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">...</span></span>
<span class="line"><span style="--shiki-light:#859900;--shiki-dark:#859900;">for</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> ligand_filename, smiles_list </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">in</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> protein_ligand_dict.items():</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	diversity </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> computer_diversity(smiles_list)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">	protein_diversities.append(diversity)</span></span>
<span class="line"><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">	print</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#586E75;--shiki-light-font-weight:bold;--shiki-dark:#93A1A1;--shiki-dark-font-weight:bold;">f</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&quot;</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">ligand_filename</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;"> 的diversity: </span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">{</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">diversity</span><span style="--shiki-light:#CB4B16;--shiki-dark:#CB4B16;">}</span><span style="--shiki-light:#2AA198;--shiki-dark:#2AA198;">&quot;</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">)</span></span>
<span class="line"><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">print</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(</span><span style="--shiki-light:#268BD2;--shiki-dark:#268BD2;">len</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;">(protein_ligand_dict))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">mean_diversity </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> np.mean(protein_diversities)</span></span>
<span class="line"><span style="--shiki-light:#657B83;--shiki-dark:#839496;">median_diversity </span><span style="--shiki-light:#859900;--shiki-dark:#859900;">=</span><span style="--shiki-light:#657B83;--shiki-dark:#839496;"> np.median(protein_diversities)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><h2 id="doc-contributors" tabindex="-1"><a href="#doc-contributors" class="header-anchor"><span>贡献者</span></a></h2><div class="vp-contributors"><a href="https://github.com/Velvet0314" target="_blank" rel="noreferrer" class="vp-contributor"><img src="https://image.velvet-notes.org/blog/avatar.png" alt class="vp-contributor-avatar"><span class="vp-contributor-name">Velvet</span></a></div><!--]--><!----><div class="vp-doc-copyright" data-v-ce8ab5ff><h2 id="doc-copyright" tabindex="-1" class="vp-doc-header" data-v-8f9b9288><a href="#doc-copyright" class="header-anchor" data-v-8f9b9288><span data-v-8f9b9288><!--[-->版权所有<!--]--></span></a></h2><div class="hint-container tip copyright-container" data-v-6e46fd1c><p data-v-6e46fd1c><span data-v-6e46fd1c>版权归属：</span><a class="vp-link link no-icon" href="https://github.com/Velvet0314" target="_blank" rel="noreferrer" data-v-6e46fd1c><!--[-->Velvet<!--]--><!----></a></p><!----><p data-v-6e46fd1c><span data-v-6e46fd1c>许可证：</span><a class="vp-link link no-icon" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer" data-v-6e46fd1c><!--[-->署名-非商业性-相同方式共享 4.0 国际 (CC-BY-NC-SA-4.0)<!--]--><!----></a><!--[--><span class="vpi-license-cc" data-v-6e46fd1c></span><span class="vpi-license-by" data-v-6e46fd1c></span><span class="vpi-license-nc" data-v-6e46fd1c></span><span class="vpi-license-sa" data-v-6e46fd1c></span><!--]--></p></div></div></div></main><footer class="vp-doc-footer" data-v-ce8ab5ff data-v-d1aa847a><!--[--><!--]--><div class="edit-info" data-v-d1aa847a><div class="edit-link" data-v-d1aa847a><a class="vp-link link no-icon edit-link-button" href="https://github.com/Velvet0314/Velvet-Blog/edit/master/docs/papers/分子生成/targetdiff.md" target="_blank" rel="noreferrer" data-v-d1aa847a><!--[--><span class="vpi-square-pen edit-link-icon" aria-label="edit icon" data-v-d1aa847a></span> 编辑此页<!--]--><!----></a></div><!----></div><!----><nav class="prev-next" data-v-d1aa847a><div class="pager" data-v-d1aa847a><a class="vp-link link pager-link prev" href="/papers/%E5%88%86%E5%AD%90%E7%94%9F%E6%88%90/ipdiff" data-v-d1aa847a><!--[--><span class="desc" data-v-d1aa847a>上一页</span><span class="title" data-v-d1aa847a>IPDiff</span><!--]--><!----></a></div><div class="pager" data-v-d1aa847a><!----></div></nav></footer><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;" data-v-ce8ab5ff><div style="display: flex;align-items: center;justify-content: center;height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);--icon-size: 48px;display: inline-block;width: var(--icon-size);height: var(--icon-size);background-color: currentcolor;-webkit-mask-image: var(--loading-icon);mask-image: var(--loading-icon)"></span></div></div><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-c0907686 data-v-fc8ff415><span class="icon vpi-back-to-top" data-v-fc8ff415></span><svg aria-hidden="true" data-v-fc8ff415><circle cx="50%" cy="50%" fill="none" style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-fc8ff415></circle></svg></button><footer class="vp-footer" vp-footer data-v-c0907686 data-v-d288e6a5><!--[--><div class="container" data-v-d288e6a5><p class="message" data-v-d288e6a5>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><p class="copyright" data-v-d288e6a5>Copyright © 2024-present Velvet</p></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/assets/app-nJSYOaSR.js" defer></script></body></html>